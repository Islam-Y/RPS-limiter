services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  application-service:
    build:
      context: ./application-service
    ports:
      - "8081:8081"

  ai-module:
    build:
      context: ./AI-RPS-limiter
    environment:
      ALLOW_ALGO_SWITCH: ${ALLOW_ALGO_SWITCH:-true}
      MIN_ALGO_SWITCH_INTERVAL_SECONDS: ${MIN_ALGO_SWITCH_INTERVAL_SECONDS:-45}
      BURSTINESS_POINTS: ${BURSTINESS_POINTS:-5}
      BURSTINESS_THRESHOLD: ${BURSTINESS_THRESHOLD:-1.3}
      TOKEN_MIN_HOLD_SECONDS: ${TOKEN_MIN_HOLD_SECONDS:-60}
      TOKEN_EXIT_NON_BURST_STREAK: ${TOKEN_EXIT_NON_BURST_STREAK:-4}
      MIN_TOKEN_FILL_RATE: ${MIN_TOKEN_FILL_RATE:-10}
      DECREASE_FACTOR: ${DECREASE_FACTOR:-0.9}
    ports:
      - "8083:8083"

  rate-limiter-service:
    build:
      context: ./rate-limiter-service
    depends_on:
      - redis
      - application-service
      - ai-module
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      TARGET_URL: http://application-service:8081
      ADAPTIVE_ENABLED: ${ADAPTIVE_ENABLED:-true}
      ADAPTIVE_URL: http://ai-module:8083/v1/limit-config
      ADAPTIVE_INTERVAL: ${ADAPTIVE_INTERVAL:-10s}
    ports:
      - "8082:8082"

  load-generator-service:
    build:
      context: ./load-generator-service
    depends_on:
      - rate-limiter-service
    ports:
      - "8080:8080"

  prometheus:
    image: prom/prometheus:v2.52.0
    depends_on:
      - application-service
      - rate-limiter-service
      - load-generator-service
      - ai-module
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"

  grafana:
    image: grafana/grafana:10.4.2
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning/datasources/prometheus.yml:/etc/grafana/provisioning/datasources/prometheus.yml:ro
      - ./monitoring/grafana/provisioning/dashboards/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards/json:ro

volumes:
  prometheus-data:
  grafana-data:
